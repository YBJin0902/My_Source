# OS Kernel Develop

#### 介紹

主旨為開發 Operating System（OS、作業系統）

目前針對對象：Linux Kernel
使用的相關工具：Yocto project

## 並行計算

在開始之前先介紹基本觀念：並行計算。</br>
這是作業系統中一定要先理解的觀念。</br>

先前已經有學過的韌體知識可以先丟掉，接下來會是不一樣的觀念。</br>

### 交錯執行、平行、並行

在不同的系統中執行流程會有不同的執行方式，也是我們常講的執行緒，在以前的觀念中我們所繪製的流程圖都是單執行緒（單核心、單CPU）。</br>

但後續我們開始了 RTOS，也就是所謂的類多執行緒，在類多執行緒中，我們會把一個單執行緒（單核心、單CPU）的系統所需要處理的事，切分成多個任務，在這樣的情況下我們做的事其實只是將程序切分成多個任務去執行而已，並不是所謂的並行或平行執行。注意，就算切成多任務也會設立明確的切割點。</br>

平行執行（Parallel），所謂的平行執行是多個程序在同一時間同時執行，最常見的情況就是在多核心晶片中，在開發這樣的系統架構時，最簡單的做法就是在不同的 CPU 中分別寫不同的程式並直接讓晶片執行，在不考慮其他的情況下（如對稱架構、非對稱架構），通常都可以直接讓 CPU 分開執行程序。</br>
用專業術語來說的話，平⾏執⾏程式的 process 或 thread 數⽬和 CPU 或核⼼
⼀樣多，每⼀個 process 或 thread 都佔⽤⼀個 CPU 或核心，使得所有 process 或 thread 都能同時執⾏。</br>

並行執行（Concurrent），並行執行的情況則較為特殊，通常他的程序會遠大於 CPU 和核心，這樣的情況下這些程序是在交錯或是平行之間執行。一開始這樣說可能很抽象，拿我們常用的作業系統舉例的話，當我們開啟很多視窗時屬於平行執行，因為 CPU 本身會一直執行我們所賦予的工作並不會隨意 Kill 掉任何程序，頂多給予的資源較少。</br>
再多一層想像，我們現在正在操作一個四核心的 CPU，此時開啟四個程式，其中一個包含記事本（具有輸入與輸出的功能），現在我們開始操作記事本，在操作記事本的同時由於四核心的架構無法負荷超過四個程序（需要輸入輸出，加上原本的四項程式，所以為六項），在這個記事本中我們一邊輸入可以一邊看到我們所輸入的文字同時顯示（交錯），此時系統會讓某些程序執行很短的時間後把核心交給其他程序使用，於是任意時刻，每一個程序在執行上都會有進展，在執行完成之前都會是做一下、停一下、再繼續做一下。</br>

</br>

### 1. 交錯執行
   ![Interleaved](images/Interleaved.png) </br>
### 2. 平行執行
   ![Parallel](images/Parallel.png) </br>
### 3. 並行執行 </br>
   Process 是在交錯執⾏或平⾏執⾏ </br>

</br>

## 同步（Synchronization）

在知道這些執行方式之後，有一個明顯的問題將會浮顯出來，也就是這些程序之間會需要互相溝通。舉個例子，今天專題小組分工，分成硬、韌、軟體，但若是組員之間沒有良好的溝通，那這個小組的運作一定有問題，甚至可能會無法完成原本預計的工作，由上述可見溝通的重要性。</br>



</br>

---

</br>

## 作業系統和硬體基本知識

### 多處理機系統、對稱多處理機系統、多核心系統 

在多核心系統中我們可以先以硬體與軟體設計兩種方式進行區分：

#### 1. 硬體

* 同構多核心架構：系統中的處理器在架構上是相同的，像是雙核心的架構中兩個都為 Cortex-A9

* 異構多核心架構：系統中的處理器在架構上是不同的，像是雙核心的架構中一個為 Cortex-A9、一個為 Cortex-M4

#### 2. 軟體設計

* SMP：Symmetric multiprocessing（對稱式架構），多個核心運行一個作業系統，而這個作業系統同等的管理多個內核，這種運作模式就是簡單提升效能。
  * 目前支援此運行模式的作業系統有：Linux，Windows，Vxworks。
  * 目前，我們的PC機使用的就是這種運作模式，一般適用於功能複雜，對即時性要求不高的系統。

* AMP：Asymmetric multiprocessing（非對稱式架構），多個核心相對獨立運作不同的任務，每個核心之間相互隔離，可以運行不同的作業系統或裸機程式。
  * AMP 的運作模式基本上不會有開銷問題，尤其是在執行裸機程式時，甚至沒有開銷，這種模式比較適合即時性高的應用。
  * 兩個核心之間的通訊與資源共享需要有一套優秀的處理機制。
  * 雖然多個核心可以運行不同的系統，但是需要有一個主要的核心，需要使用該核心來控制整個系統以及其他的核心。
    * 例如：一個核心運行運行即時性較高的任務，另一個核心運行 UI 介面。

* BMP：bound multiprocessing，BMP 運作模式與 SMP 類似，同樣也是一個 OS 管理所有的核心，但開發者可以指定將某個任務只在某個指定核心上執行。

### 雙執行模式

### Interrupt & Trap

